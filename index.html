<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>TAAMS DApp - Roue de la Chance</title>
  <style>
    body {
      font-family: Arial, sans-serif;
      text-align: center;
      background-color: #f0f0f0;
      padding: 20px;
    }
    .container {
      max-width: 600px;
      margin: auto;
      background: white;
      padding: 20px;
      border-radius: 10px;
    }
    button {
      padding: 10px 20px;
      margin: 10px;
      font-size: 16px;
      cursor: pointer;
      background-color: #007bff;
      color: white;
      border: none;
      border-radius: 5px;
    }
    button:hover {
      background-color: #0056b3;
    }
    button:disabled {
      background-color: #cccccc;
      cursor: not-allowed;
    }
    #wheel {
      width: 200px;
      height: 200px;
      border-radius: 50%;
      background: conic-gradient(red, yellow, green, blue, purple);
      margin: 20px auto;
      display: none;
    }
    #wheel.spinning {
      animation: spin 2s linear infinite;
    }
    @keyframes spin {
      from {
        transform: rotate(0deg);
      }
      to {
        transform: rotate(360deg);
      }
    }
    #status {
      margin: 20px;
      font-weight: bold;
    }
    .notice {
      font-size: 14px;
      color: #888;
      margin-top: 10px;
    }
    input {
      padding: 8px;
      margin: 10px;
      font-size: 16px;
    }
  </style>
</head>
<body>
  <div class="container">
    <h1>TAAMS DApp</h1>
    <p id="status">Connectez votre portefeuille</p>
    <button onclick="connectWallet()">Connecter MetaMask</button>

    <div>
      <input id="burnAmount" type="number" placeholder="Montant √† br√ªler (TAAMS)" min="1" />
      <button onclick="burnTokens()">Br√ªler TAAMS</button>
    </div>

    <div>
      <input id="stakeAmount" type="number" placeholder="Montant √† staker (min 1000 TAAMS)" min="1000" />
      <button onclick="stakeTokens()">Staker TAAMS</button>
    </div>

    <button onclick="unstakeTokens()">Destaker TAAMS</button>

    <button id="spinButton" onclick="spinWheel()" disabled>Tourner la roue</button>
    <div id="wheel"></div>
    <p class="notice" id="eligibilityMsg"></p>
  </div>
<script src="https://cdn.jsdelivr.net/npm/ethers@5.7.0/dist/ethers.umd.min.js"></script>

<script>
  let provider, signer, contract, userAddress;

  async function connectWallet() {
    if (window.ethereum) {
      try {
        provider = new ethers.providers.Web3Provider(window.ethereum);
        await provider.send("eth_requestAccounts", []);
        signer = provider.getSigner();
        userAddress = await signer.getAddress();

        contract = new ethers.Contract(contractAddress, contractABI, signer);

        document.getElementById("status").innerText = `‚úÖ Connect√© : ${userAddress}`;
        updateStatus();
      } catch (error) {
        document.getElementById("status").innerText = `‚ùå Erreur connexion : ${error.message}`;
      }
    } else {
      document.getElementById("status").innerText = "‚ö†Ô∏è MetaMask non d√©tect√©";
    }
  }

  async function updateStatus() {
    try {
      if (!userAddress || !ethers.utils.isAddress(userAddress)) {
        throw new Error("‚ö†Ô∏è Adresse utilisateur invalide ou non connect√©e");
      }

      const [balance, bl2pBalance, stakingInfo, eligibility] = await Promise.all([
        contract.balanceOf(userAddress),
        contract.bl2pClaimed(userAddress),
        contract.getStakingInfo(userAddress),
        contract.getWheelSpinEligibility(userAddress)
      ]);

      const eligible = eligibility.eligible;
      const nextSpin = eligibility.nextSpinTime;

      document.getElementById("status").innerHTML = `
        <strong>Solde TAAMS</strong> : ${ethers.utils.formatEther(balance)} TAAMS<br>
        <strong>Solde BL2P</strong> : ${ethers.utils.formatEther(bl2pBalance)} BL2P<br>
        <strong>Staking</strong> : ${ethers.utils.formatEther(stakingInfo[0])} TAAMS<br>
        <strong>R√©compense staking</strong> : ${ethers.utils.formatEther(stakingInfo[2])} BL2P<br>
        <strong>Prochain spin</strong> : ${
          eligible ? "üéØ Disponible maintenant" : new Date(nextSpin * 1000).toLocaleString()
        }
      `;

      const spinEligible = eligible && bl2pBalance.gt(0);
      document.getElementById("spinButton").disabled = !spinEligible;

      document.getElementById("eligibilityMsg").innerText =
        spinEligible ? "" : "üîí Vous devez avoir des BL2P et √™tre √©ligible pour tourner la roue.";

    } catch (error) {
      document.getElementById("status").innerText = `‚ùå Erreur mise √† jour : ${error.message}`;
    }
  }
</script>
<script>
  async function burnTokens() {
    try {
      if (!contract || !userAddress) throw new Error("Portefeuille non connect√©");

      const amount = document.getElementById("burnAmount").value;
      if (!amount || amount <= 0) throw new Error("‚ùå Montant invalide");

      const tx = await contract.participateInBurn(ethers.utils.parseEther(amount));
      await tx.wait();

      document.getElementById("status").innerText = `üî• ${amount} TAAMS br√ªl√©s avec succ√®s`;
      updateStatus();
    } catch (error) {
      document.getElementById("status").innerText = `‚ùå Erreur burn : ${error.message}`;
    }
  }

  async function stakeTokens() {
    try {
      if (!contract || !userAddress) throw new Error("Portefeuille non connect√©");

      const amount = document.getElementById("stakeAmount").value;
      if (!amount || amount < 1000) throw new Error("‚ùå Minimum 1000 TAAMS requis");

      const tx = await contract.stake(ethers.utils.parseEther(amount));
      await tx.wait();

      document.getElementById("status").innerText = `‚úÖ ${amount} TAAMS stak√©s`;
      updateStatus();
    } catch (error) {
      document.getElementById("status").innerText = `‚ùå Erreur staking : ${error.message}`;
    }
  }

  async function unstakeTokens() {
    try {
      if (!contract || !userAddress) throw new Error("Portefeuille non connect√©");

      const tx = await contract.unstake();
      await tx.wait();

      document.getElementById("status").innerText = `üì§ TAAMS destak√©s avec succ√®s`;
      updateStatus();
    } catch (error) {
      document.getElementById("status").innerText = `‚ùå Erreur destaking : ${error.message}`;
    }
  }

  async function spinWheel() {
    try {
      if (!contract || !userAddress) throw new Error("Portefeuille non connect√©");

      document.getElementById("wheel").style.display = "block";
      document.getElementById("wheel").classList.add("spinning");

      const tx = await contract.spinWheel();
      const receipt = await tx.wait();

      const event = receipt.events?.find(e => e.event === "WheelSpun");
      if (!event) throw new Error("√âv√©nement WheelSpun non d√©tect√©");

      const reward = ethers.utils.formatEther(event.args.reward);
      document.getElementById("status").innerText = `üéâ Vous avez gagn√© ${reward} TAAMS !`;

      document.getElementById("wheel").classList.remove("spinning");
      updateStatus();
    } catch (error) {
      document.getElementById("status").innerText = `‚ùå Erreur roue : ${error.message}`;
      document.getElementById("wheel").classList.remove("spinning");
    }
  }
</script>
<script>
  window.addEventListener("load", async () => {
    if (window.ethereum && window.ethereum.selectedAddress) {
      await connectWallet();
    }
  });

  async function checkNetwork() {
    const network = await provider.getNetwork();
    const targetChainId = 11155111; // Exemple : Sepolia = 11155111
    if (network.chainId !== targetChainId) {
      document.getElementById("status").innerText =
        `‚ö†Ô∏è R√©seau incorrect : veuillez passer sur Sepolia pour interagir avec le contrat`;
      throw new Error("R√©seau non compatible");
    }
  }

  async function connectWallet() {
    if (window.ethereum) {
      try {
        provider = new ethers.providers.Web3Provider(window.ethereum);
        await provider.send("eth_requestAccounts", []);
        await checkNetwork();

        signer = provider.getSigner();
        userAddress = await signer.getAddress();
        contract = new ethers.Contract(contractAddress, contractABI, signer);

        document.getElementById("status").innerText = `‚úÖ Connect√© : ${userAddress}`;
        updateStatus();
      } catch (error) {
        document.getElementById("status").innerText = `‚ùå Erreur connexion : ${error.message}`;
      }
    } else {
      document.getElementById("status").innerText = "‚ö†Ô∏è MetaMask non d√©tect√©";
    }
  }

  async function updateStatus() {
    try {
      document.getElementById("status").innerText = "‚è≥ Chargement des donn√©es...";
      
      if (!userAddress || !ethers.utils.isAddress(userAddress)) {
        throw new Error("‚ö†Ô∏è Adresse utilisateur invalide ou non connect√©e");
      }

      const [balance, bl2pBalance, stakingInfo, eligibility] = await Promise.all([
        contract.balanceOf(userAddress),
        contract.bl2pClaimed(userAddress),
        contract.getStakingInfo(userAddress),
        contract.getWheelSpinEligibility(userAddress)
      ]);

      const eligible = eligibility.eligible;
      const nextSpin = eligibility.nextSpinTime;

      document.getElementById("status").innerHTML = `
        <strong>Solde TAAMS</strong> : ${ethers.utils.formatEther(balance)} TAAMS<br>
        <strong>Solde BL2P</strong> : ${ethers.utils.formatEther(bl2pBalance)} BL2P<br>
        <strong>Staking</strong> : ${ethers.utils.formatEther(stakingInfo[0])} TAAMS<br>
        <strong>R√©compense staking</strong> : ${ethers.utils.formatEther(stakingInfo[2])} BL2P<br>
        <strong>Prochain spin</strong> : ${
          eligible ? "üéØ Disponible maintenant" : new Date(nextSpin * 1000).toLocaleString()
        }
      `;

      const spinEligible = eligible && bl2pBalance.gt(0);
      document.getElementById("spinButton").disabled = !spinEligible;
      document.getElementById("eligibilityMsg").innerText =
        spinEligible ? "" : "üîí Vous devez avoir des BL2P et √™tre √©ligible pour tourner la roue.";
    } catch (error) {
      document.getElementById("status").innerText = `‚ùå Erreur mise √† jour : ${error.message}`;
    }
  }
</script>
  </script>
</body>
</html>
